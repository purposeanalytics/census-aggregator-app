---
output:
  html_document:
    theme:
      version: 4
# params:
#   geo_uid: !r c("3520005")
#   level: "csd"
params:
  # geo_uid: !r c("5350612.10")
  geo_uid: !r c("5050110.00", "5050120.01")
  # level: "csd"
  level: "ct"
  csv_location: "data_export.csv"
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE,
  out.width = "100%", fig.height = 2
)
```

```{css css-styles}
.section-heading {
  background-color: lightgrey;
  padding-left: 5px;
}

.box {
  height: 100%;
  background-color: lightgrey;
  # text-align: center;
  padding: 0.5rem;
  # margin-right: 0.5rem;
  display: flex;
  flex-direction: column;
}

.box-last {
  # margin-right: 0;
  # margin-left: 0.5rem;
}

.card-value {
  margin-top: auto;
  font-size: 2rem;
  font-weight: bold;
}
```

```{r html-utils}
section_heading <- function(title) {
  htmltools::div(
    class = "section-heading",
    htmltools::h1(title)
  )
}

subsection_heading <- function(title, class = NULL) {
  htmltools::div(
    class = "section-heading",
    htmltools::h2(title)
  )
}

snapshot_card_value <- function(value) {
  htmltools::div(
    class = "card-value",
    value
  )
}

snapshot_card <- function(title, value, ..., class = NULL) {
  htmltools::div(
    class = paste("box", class),
    htmltools::div(htmltools::HTML(title)),
    snapshot_card_value(value),
    htmltools::div(...)
  )
}

header_and_barchart <- function(...) {
  shiny::column(
    width = 6,
    ...
  )
}

pull_and_format_value <- function(data, format = "percent") {
  value <- data[["value"]]

  if (is.na(value)) {
    return(htmltools::HTML("&#8212;"))
  }

  switch(format,
    percent = scales::percent(value, 0.1),
    comma = scales::comma(value, 1),
    dollar = scales::dollar(value)
  )
}
```

```{r packages}
library(dplyr)
library(censusaggregate)
library(purrr)
library(scales)
library(tidyr)
library(stringr)
library(bslib)
library(arrow)
library(censusaggregatorapp)
library(sfarrow)
library(ggplot2)
library(sf)
```

```{r data}
regions <- params$geo_uid
level <- params$level
dataset <- glue::glue("extdata/{level}_values")

data <- open_dataset(system.file(dataset, package = "censusaggregatorapp"))

vectors_data <- data %>%
  filter(geo_uid %in% regions) %>%
  select(-id) %>%
  collect()

vectors_data <- vectors_data %>%
  mutate(geo_uid = forcats::fct_expand(geo_uid, regions))

metadata <- switch(level,
  "csd" = csd,
  "ct" = ct
) %>%
  filter(geo_uid %in% regions)

vectors_data <- vectors_data %>%
  # tidyr::complete(vector, geo_uid, fill = list(value = 0)) %>%
  left_join(metadata, by = "geo_uid")

vectors_data <- vectors_data %>%
  left_join(censusaggregatorapp::vectors, by = "vector") %>%
  derive_aggregation_type()

# Aggregate vectors - treat land area separately (used for population density), population 2016 separately ), median total income separately (used for median income if only 1 region selected)
vectors_data_filtered <- vectors_data %>%
  filter(!(label %in% c("Population, 2016", "Land area in square kilometres", "Median total household income")))

# Also exclude income vectors, aggregate separately

data_breakdown <- vectors_data_filtered %>%
  aggregate_census_vectors() %>%
  distinct() %>%
  left_join(censusaggregatorapp::vectors, by = c("highest_parent_vector", "vector", "type", "label", "units", "parent_vector", "aggregation", "details")) %>%
  select(highest_parent_vector, vector, label, label_short, value, value_proportion) %>%
  group_by(highest_parent_vector) %>%
  tidyr::fill(label_short, .direction = "updown") %>%
  ungroup() %>%
  distinct()
```

```{r map, fig.height = 5, dpi = 300}
boundaries_dataset <- glue::glue("extdata/{level}")

boundaries_data <- open_dataset(system.file(boundaries_dataset, package = "censusaggregatorapp"))
boundaries_data <- boundaries_data %>%
  filter(geo_uid %in% regions) %>%
  read_sf_dataset()

multiple_regions <- length(regions) > 1

if (multiple_regions) {
  combined_boundaries <- boundaries_data %>%
    st_union()

  initial_colour <- "grey"
} else {
  initial_colour <- "black"
}

p <- ggplot() +
  geom_sf(data = boundaries_data, colour = initial_colour, fill = NA) +
  theme_void()

if (multiple_regions) {
  p <- p +
    geom_sf(data = combined_boundaries, colour = "black", fill = NA)
}

p
```


```{r snapshot_heading}
section_heading("Snapshot")
```

::: {.row .mb-2}

```{r snapshot}
# Number of geographies (CSDs/CTs), population, number of households, population change (2011 to 2016), population density

areas_selected <- glue::glue("{n} {geography}{s}",
  n = length(unlist(regions)),
  geography = case_when(
    level == "CSD" ~ "Census subdivision",
    level == "CT" ~ "Census tract"
  ),
  s = ifelse(n > 1, "s", "")
)

population <- data_breakdown %>%
  filter(label_short == "population_2021") %>%
  pull_and_format_value("comma")

households <- metadata %>%
  select(geo_uid, households) %>%
  distinct() %>%
  summarise(value = sum(households)) %>%
  pull_and_format_value("comma")

population_change <- vectors_data %>%
  aggregate_population_change()

population_change_formatted <- population_change %>%
  pull_and_format_value()

population_density <- vectors_data %>%
  filter(label %in% c("Population, 2021", "Land area in square kilometres")) %>%
  aggregate_population_density() %>%
  pull_and_format_value("comma")
```

```{r population}
shiny::column(
  width = 3,
  snapshot_card("Population", population)
)
```

```{r households}
shiny::column(
  width = 3,
  snapshot_card("Households", households)
)
```

```{r population_change}
shiny::column(
  width = 3,
  snapshot_card("Population change<br>(2016 to 2021)", population_change_formatted)
)
```

```{r population_density}
shiny::column(
  width = 3,
  snapshot_card("Population density<br>(people per square km)", population_density)
)
```

:::

```{r section-age-households-families}
section_heading("Age, households, and families")
```

::: {.row .mb-2}

```{r age-cohorts, out.height = 1}
age_cohorts <- data_breakdown %>%
  filter(
    label_short == "age_cohorts",
    vector != highest_parent_vector
  ) %>%
  mutate(label = forcats::fct_reorder(label, label))

header_and_barchart(
  subsection_heading("Population by age cohorts"),
  age_cohorts %>%
    inline_barchart()
)
```

```{r household_size}
household_size <- data_breakdown %>%
  filter(
    label_short == "household_size",
    vector != highest_parent_vector
  )

header_and_barchart(
  subsection_heading("Private households by size"),
  household_size %>%
    inline_barchart()
)
```

```{r family_type}
family_type <- data_breakdown %>%
  filter(
    label_short == "family_type",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

header_and_barchart(
  subsection_heading("Family type"),
  family_type %>%
    inline_barchart()
)
```

```{r household_type}
multiple_family_households <- data_breakdown %>%
  filter(
    label_short == "household_type",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

header_and_barchart(
  subsection_heading("Multiple family households"),
  multiple_family_households %>%
    inline_barchart()
)
```

```{r educational_attainment, eval = FALSE}
educational_attainment <- data_breakdown %>%
  filter(
    label_short == "educational_attainment",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

header_and_barchart(
  subsection_heading("Educational attainment"),
  educational_attainment %>%
    inline_barchart()
)
```

:::

```{r section-language}
section_heading("Language")
```

::: {.row .mb-2}

```{r knowledge_of_english}
knowledge_of_official_languages <- data_breakdown %>%
  filter(
    label_short == "knowledge_of_english_french",
    vector != highest_parent_vector
  )

knowledge_of_english <- knowledge_of_official_languages %>%
  filter(
    label %in% c("English only", "English and French")
  ) %>%
  pull(value_proportion) %>%
  sum() %>%
  percent()

shiny::column(
  width = 3,
  snapshot_card("Knowledge of English", knowledge_of_english)
)
```

```{r knowledge_of_french}
knowledge_of_french <- knowledge_of_official_languages %>%
  filter(
    label %in% c("French only", "English and French")
  ) %>%
  pull(value_proportion) %>%
  sum() %>%
  percent()

shiny::column(
  width = 3,
  snapshot_card("Knowledge of French", knowledge_of_french)
)
```

```{r english-at-home}
english_at_home <- data_breakdown %>%
  filter(
    label_short == "top_10_languages",
    label %in% c(
      "English", "English and French",
      "English and non-official language(s)", "English, French and non-official language(s)"
    )
  ) %>%
  pull(value_proportion) %>%
  sum() %>%
  percent()

shiny::column(
  width = 3,
  snapshot_card("English spoken at home", english_at_home)
)
```

```{r french-at-home}
french_at_home <- data_breakdown %>%
  filter(
    label_short == "top_10_languages",
    label %in% c(
      "French", "English and French", "French and non-official language(s)",
      "English, French and non-official language(s)"
    )
  ) %>%
  pull(value_proportion) %>%
  sum() %>%
  percent()

shiny::column(
  width = 3,
  snapshot_card("French spoken at home", french_at_home)
)
```

:::

::: {.row}

```{r language_at_home}
language_at_home <- data_breakdown %>%
  filter(
    label_short == "top_10_languages",
    vector != highest_parent_vector
  ) %>%
  inner_join(vectors %>%
    filter(label_short == "top_10_languages", str_detect(details, "Single")) %>%
    select(vector), by = "vector") %>%
  filter(!label %in% c("English", "French")) %>%
  top_n(10, wt = value) %>%
  filter(value > 0) %>%
  arrange(-value) %>%
  head(10) %>%
  derive_census_vector_order(by_value = TRUE)

header_and_barchart(
  subsection_heading("Non-official language spoken at home"),
  language_at_home %>%
    inline_barchart()
)
```

:::

```{r section-income-housing}
section_heading("Income and housing")
```

::: {.row .mb-2}

```{r median_income}
# If there is only one region, just report the actual median
# Otherwise, estimate the median

if (length(regions) == 1) {
  median_income <- vectors_data %>%
    filter(vector == "v_CA21_906")
  median_income_label <- "Median household income"
} else {
  median_income <- data_breakdown %>%
    filter(label_short == "income") %>%
    aggregate_estimated_median_income()
  median_income_label <- "Estimated median household income"
}

median_income <- median_income %>%
  pull_and_format_value("dollar")

shiny::column(
  width = 4,
  snapshot_card(median_income_label, median_income)
)
```

```{r lim_at}
lim_at <- data_breakdown %>%
  filter(label_short == "lim_at") %>%
  select(-value, value = value_proportion) %>%
  pull_and_format_value()

shiny::column(
  width = 4,
  snapshot_card("Low income (LIM-AT)", lim_at)
)
```

```{r unaffordable_housing}
unaffordable_housing <- data_breakdown %>%
  filter(
    label_short == "unaffordable_housing",
    vector != highest_parent_vector
  ) %>%
  select(-value, value = value_proportion) %>%
  pull_and_format_value()

shiny::column(
  width = 4,
  snapshot_card("Unaffordable housing", unaffordable_housing)
)
```

:::

::: {.row}

```{r total-income}
total_income <- data_breakdown %>%
  filter(label_short == "income_buckets") %>%
  mutate(label = forcats::fct_relevel(
    label, "Under $20,000", "$20,000 to $40,000", "$40,000 to $60,000",
    "$60,000 to $80,000", "$80,000 to $100,000", "$100,000 and over"
  ))

header_and_barchart(
  subsection_heading("Total household income"),
  total_income %>%
    inline_barchart()
)
```

```{r shelter-cost}
shelter_cost <- data_breakdown %>%
  filter(
    str_starts(label_short, "shelter_cost"),
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()


household_tenure <- data_breakdown %>%
  filter(
    label_short == "household_tenure",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

header_and_barchart(
  subsection_heading("Average shelter cost"),
  shelter_cost %>%
    inline_barchart("dollar"),
  subsection_heading("Household tenure"),
  household_tenure %>%
    inline_barchart()
)
```


```{r household-tenure}
```

:::

```{r section-diversity-immigration, eval = FALSE}
section_heading("Diversity and immigration")
```

::: {.row .mb-2}

```{r visible-minority-summary, eval = FALSE}
visible_minority <- data_breakdown %>%
  filter(
    label_short == "visible_minority",
    vector != highest_parent_vector
  )

visible_minority_summary <- visible_minority %>%
  filter(label == "Total visible minority population") %>%
  select(-value, value = value_proportion) %>%
  pull_and_format_value()

shiny::column(
  width = 3,
  snapshot_card("Visible minority", visible_minority_summary)
)
```

```{r immigrant-status, eval = FALSE}
immigrant_status <- data_breakdown %>%
  filter(
    label_short == "immigrant_status",
    vector != highest_parent_vector
  ) %>%
  select(-value) %>%
  rename(value = value_proportion)

immigrant_status_total <- immigrant_status %>%
  filter(label == "Immigrants") %>%
  pull_and_format_value()

immigrant_status_recent <- immigrant_status %>%
  filter(label != "Immigrants") %>%
  pull_and_format_value()

shiny::column(
  width = 3,
  snapshot_card("Total immigrants", immigrant_status_total)
)

shiny::column(
  width = 3,
  snapshot_card("Recent immigrants<br>(2011 to 2016)", immigrant_status_recent)
)
```

```{r aboriginal-identity, eval = FALSE}
aboriginal_identity <- data_breakdown %>%
  filter(
    label_short == "aboriginal_identity",
    vector != highest_parent_vector
  ) %>%
  select(-value, value = value_proportion) %>%
  pull_and_format_value()

shiny::column(
  width = 3,
  snapshot_card("Aboriginal identity", aboriginal_identity)
)
```

:::

::: {.row}

```{r visible-minority-breakdown, eval = FALSE}
visible_minority <- data_breakdown %>%
  filter(
    label_short == "visible_minority",
    vector != highest_parent_vector
  ) %>%
  filter(!label %in% c("Total visible minority population", "Not a visible minority")) %>%
  derive_census_vector_order(TRUE)

header_and_barchart(
  subsection_heading("Visible minority population"),
  visible_minority %>%
    inline_barchart()
)
```

```{r ethnic_origin, eval = FALSE}
ethnic_origin <- data_breakdown %>%
  filter(label_short == "ethnic_origin") %>%
  filter(vector != highest_parent_vector) %>%
  top_n(10, wt = value) %>%
  arrange(-value) %>%
  derive_census_vector_order(by_value = TRUE)

header_and_barchart(
  subsection_heading("Ethnic origin"),
  ethnic_origin %>%
    inline_barchart()
)
```

:::

#### IDs

```{r, output = "asis"}
dput(regions)
```

```{r data-export}
# Start prepping data for export
# Add highest parent vector label to each, and relabel breakdowns to "breakdown"
highest_parent_vector_label <- data_breakdown %>%
  filter(vector == highest_parent_vector) %>%
  select(highest_parent_vector, vector = label)

breakdowns <- data_breakdown %>%
  filter(vector != highest_parent_vector) %>%
  select(highest_parent_vector, breakdown = label, value, value_proportion, label_short)

data_export <- breakdowns %>%
  left_join(highest_parent_vector_label, by = "highest_parent_vector") %>%
  select(vector, breakdown, value, value_proportion, label_short)

data_export <- bind_rows(
  tribble(
    ~vector, ~value,
    "Population, 2021", population,
    "Households", households,
    "Population change (2016 to 2021)", as.character(population_change[["value"]]),
    "Population density", population_density
  ) %>%
    mutate(
      value = readr::parse_number(value),
      breakdown = vector
    ),
  # Household size
  data_export %>% filter(label_short == "household_size"),
  # (Estimated) median household income
  tibble(vector = median_income_label, value = median_income) %>%
    mutate(
      value = readr::parse_number(value),
      breakdown = vector
    ),
  # Buckets

  data_export %>% filter(label_short == "income_buckets"),

  # Original breakdowns

  data_export %>% filter(label_short == "income"),

  # Unaffordable housing

  data_export %>% filter(label_short == "unaffordable_housing"),

  # Low-income measure after tax (LIM-AT)
  data_export %>% filter(label_short == "lim_at"),
  # Visible minority population
  # Total visible minority population (and all breakdowns within)
  # Household tenure
  data_export %>% filter(label_short == "household_tenure"),
  # Average shelter cost
  data_export %>% filter(label_short %in% c("shelter_cost_owner", "shelter_cost_renter")),
  # Age (5 year buckets)
  data_export %>%
    filter(label_short == "age") %>%
    separate(breakdown,
      into = c("min", "max"),
      sep = " to ", remove = FALSE, convert = TRUE, fill = "right"
    ) %>%
    arrange(max) %>%
    select(-min, -max) %>%
    mutate(vector = "Age (5 year groups)"),
  # Age (cohorts)
  data_export %>%
    filter(label_short == "age_cohorts") %>%
    separate(breakdown,
      into = c("min", "max"),
      sep = " to ", remove = FALSE, convert = TRUE, fill = "right"
    ) %>%
    arrange(max) %>%
    select(-min, -max) %>%
    mutate(vector = "Age (cohorts)"),
  # Language spoken at home
  # TODO
  # Knowledge of English
  data_export %>% filter(label_short == "knowledge_of_english"),
  # Immigrant Status
  # Immigrants, Recent Immigrants (since 2016)
  # Aboriginal identity
  # Country of origin
  # Educational attainment
  # Family type
  data_export %>% filter(label_short == "family_type"),
  # Multiple family households
  data_export %>% filter(label_short == "household_type")
) %>%
  select(vector, breakdown, value, value_proportion) %>%
  mutate(value_proportion = round(value_proportion, 3))

# TODO
# Round value proportion
# Fix Household total income groups in 2020 for private households
# Fix Average monthly shelter cost having prop

readr::write_csv(data_export, params$csv_location)
```
