---
title: "CensusAggregator Report"
output:
  html_document:
    theme:
      version: 4
params:
  geo_uid: !r c("5947807")
  geography: "csd"
  bookmark: "https://censusaggregator.ca/"
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, error = TRUE
)
```

```{css css-styles}
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');

:root {
  --font: "Lato", Sans-Serif;
  --base-size: 14px;
  --regular-weight: 400;
  --bold-weight: 700;
  --main-background-color: #61A89A;
  --main-color: #447E72;
  --secondary-color: #3D3D3D;
  --tertiary-color: #BFBFBF;
  --breathing-room: 10px
}

body {
  font-family: var(--font);
  font-size: var(--base-size);
  font-weight: var(--regular-weight);
}

.title {
  display: none;
}

.section-heading hr {
  border-top: 2px solid var(--main-background-color);
}

.subsection-heading {
  font-weight: var(--bold-weight);
  background-color: white;
  color: var(--main-color);
  padding-top: 0.5rem;
  padding-bottom: 0;
}

.box {
  height: 100%;
  background-color: var(--main-background-color);
  color: white;
  # text-align: center;
  padding: 0.5rem;
  # margin-right: 0.5rem;
  display: flex;
  flex-direction: column;
}

.card-value {
  margin-top: auto;
  font-size: 2rem;
  font-weight: bold;
}

h1 {
  font-size: 2rem;
}

h2 {
  font-size: 1.25rem;
}

.print-header {
  display: block;
  width: 100%;
}

.print-header.page-header {
  display: none;
}

.print-header .left-logo {
  float: left;
  text-align: left;
  width: 50%
}

.print-header .right-logo {
  float: right;
  text-align: right;
  width: 50%
}

@media print {
  .pagebreak {
    page-break-before: always;
  }

  .print-header.page-header {
    display: block;
  }

  @page {
    @bottom-center {
      content: counter(page);
    }
  }
}
```

```{r html-utils}
section_heading <- function(title) {
  htmltools::div(
    htmltools::hr(),
    htmltools::div(
      class = "section-heading",
      htmltools::h1(title),
      htmltools::hr()
    )
  )
}

subsection_heading <- function(title, class = NULL) {
  htmltools::div(
    class = "subsection-heading",
    htmltools::h2(title)
  )
}

snapshot_card_value <- function(value) {
  htmltools::div(
    class = "card-value",
    value
  )
}

snapshot_card <- function(title, value, ..., class = NULL) {
  htmltools::div(
    class = paste("box", class),
    htmltools::div(htmltools::HTML(title)),
    snapshot_card_value(value),
    htmltools::div(...)
  )
}

header_and_barchart <- function(...) {
  shiny::column(
    width = 6,
    ...
  )
}

pull_and_format_value <- function(data, format = "percent", column = "value") {
  value <- data[[column]]

  if (is.na(value)) {
    return(htmltools::HTML("&#8212;"))
  }

  switch(format,
    percent = scales::percent(value, 0.1),
    comma = scales::comma(value, 1),
    comma_decimal = scales::comma(value, 0.1),
    dollar = scales::dollar(value)
  )
}

logo <- function(pagebreak = TRUE) {
  logo_height <- "100px"

  shiny::div(
    class = "print-header",
    shiny::div(
      class = "left-logo",
      shiny::img(
        src = system.file("app/www/logo.png", package = "censusaggregatorapp"),
        height = logo_height,
        alt = "CensusAggregator logo"
      ), style = ""
    ),
    shiny::div(
      class = "right-logo",
      shiny::img(
        src = system.file("app/www/pa-logo.png", package = "censusaggregatorapp"),
        height = logo_height,
        alt = "Purpose Analytics logo"
      )
    )
  )
}

suppressed_note <- function(...) {
  data <- list(...)

  if (any(data == "&#8212;")) {
    shiny::div(
      shiny::HTML("<i>Note: &#8212; indicates data for one or more of the selected areas is not available or is suppressed due to confidentiality.</i>")
    )
  }
}
```

```{r packages}
library(dplyr)
library(censusaggregate)
library(purrr)
library(scales)
library(tidyr)
library(stringr)
library(bslib)
library(arrow)
library(censusaggregatorapp)
library(sfarrow)
library(ggplot2)
library(sf)
library(forcats)
```

```{r data}
geography <- params$geography
regions <- params$geo_uid

data <- prepare_data(geography, regions) %>%
  split(.$label) %>%
  purrr::map(~ .x %>%
    select(-label) %>%
    rename(label = breakdown))
```

```{r}
logo(FALSE)
```

```{r map, fig.height = 3.25, dpi = 150, fig.alt = "A map showing the outline of the selected geographies."}
boundaries_dataset <- glue::glue("extdata/{geography}")

boundaries_data <- open_dataset(system.file(boundaries_dataset, package = "censusaggregatorapp"))
boundaries_data <- boundaries_data %>%
  read_sf_dataset()

# Limit to regions, combine boundaries
region_boundaries <- boundaries_data %>%
  filter(geo_uid %in% regions)
region_boundaries <- region_boundaries %>%
  st_union()

# Get bounding box
regions_bbox <- region_boundaries %>%
  st_bbox()

# Add 10% buffer to bbox, based on which of height/width is smaller
smaller_size <- min(regions_bbox$xmax - regions_bbox$xmin, regions_bbox$ymax - regions_bbox$ymin)
bbox_buffer <- smaller_size * 0.05

regions_bbox[["xmin"]] <- regions_bbox$xmin - bbox_buffer
regions_bbox[["ymin"]] <- regions_bbox$ymin - bbox_buffer
regions_bbox[["xmax"]] <- regions_bbox$xmax + bbox_buffer
regions_bbox[["ymax"]] <- regions_bbox$ymax + bbox_buffer

# Get all boundaries within bbox
all_boundaries_in_bbox <- boundaries_data %>%
  st_crop(regions_bbox)

ggplot() +
  geom_sf(data = all_boundaries_in_bbox, colour = "grey", fill = NA, size = 0.3) +
  geom_sf(data = region_boundaries, colour = "black", fill = "white", alpha = 0.75, size = 0.5) +
  geom_rect(aes(xmin = regions_bbox$xmin, xmax = regions_bbox$xmax, ymin = regions_bbox$ymin, ymax = regions_bbox$ymax), fill = NA, colour = "grey", size = 0.3) +
  theme_void()

# tmap::tm_shape(all_boundaries_in_bbox) + tmap::tm_polygons(alpha = 0, border.col = "grey") + tmap::tm_shape(region_boundaries) + tmap::tm_polygons(alpha = 0.75, border.col = "black", col = "white") + tmap::tm_layout(frame = FALSE)
```

```{r}
shiny::tags$a(href = params$bookmark, "Bookmark", target = "_blank")
```

::: {.row .mb-2}

```{r snapshot}
population <- data[["Population, 2021"]] %>%
  pull_and_format_value("comma")

households <- data[["Households"]] %>%
  pull_and_format_value("comma")

population_change <- data[["Population change, 2016 to 2021"]] %>%
  pull_and_format_value()

if (!str_starts(population_change, "-")) {
  population_change <- paste0("+", population_change)
}

population_density <- data[["Population density"]] %>%
  pull_and_format_value("comma_decimal")
```

```{r population}
shiny::column(
  width = 3,
  snapshot_card("Population", population)
)
```

```{r households}
shiny::column(
  width = 3,
  snapshot_card("Households", households)
)
```

```{r population_change}
shiny::column(
  width = 3,
  snapshot_card("Population change<br>(2016 to 2021)", population_change)
)
```

```{r population_density}
shiny::column(
  width = 3,
  snapshot_card("Population density<br>(people/km<sup>2</sup>)", population_density)
)
```
:::

```{r}
suppressed_note(population, households, population_change, population_density)
```

```{r section-age-households-families}
section_heading("Age, households, and families")
```

::: {.row .mb-2}

```{r age-cohorts-household-size-family-type}
header_and_barchart(
  subsection_heading("Population by age cohorts"),
  data[["Age (cohorts)"]] %>%
    inline_barchart(),
  subsection_heading("Private households by size"),
  data[["Household size"]] %>%
    inline_barchart()
)
```

```{r household_type}
header_and_barchart(
  subsection_heading("Family type"),
  data[["Family type"]] %>%
    inline_barchart(),
  subsection_heading("Household type"),
  data[["Household type"]] %>%
    inline_barchart()
)
```

:::

<div class = "pagebreak"></div>

```{r section-language}
section_heading("Language")
```

::: {.row .mb-2}

```{r knowledge_of_english}
knowledge_of_english <- data[["Knowledge of official languages"]] %>%
  filter(label == "Knowledge of English") %>%
  pull_and_format_value(column = "value_proportion")

shiny::column(
  width = 3,
  snapshot_card(
    "Knowledge of English", knowledge_of_english
  )
)
```

```{r knowledge_of_french}
knowledge_of_french <- data[["Knowledge of official languages"]] %>%
  filter(label == "Knowledge of French") %>%
  pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 3,
  snapshot_card("Knowledge of French", knowledge_of_french)
)
```

```{r english-at-home}
english_at_home <- data[["Official languages primarily spoken at home"]] %>%
  filter(label == "English spoken at home") %>%
  pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 3,
  snapshot_card("English spoken at home", english_at_home)
)
```

```{r french-at-home}
french_at_home <- data[["Official languages primarily spoken at home"]] %>%
  filter(label == "French spoken at home") %>%
  pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 3,
  snapshot_card("French spoken at home", french_at_home)
)
```

:::

```{r}
suppressed_note(knowledge_of_english, knowledge_of_french, english_at_home, french_at_home)
```

::: {.row}

```{r language_at_home}
top_languages <- data[["Top 10 non-official languages primarily spoken at home"]]
if (is.null(top_languages)) {
  top_languages <- "No non-official languages primarily spoken at home."
} else {
  top_languages <- data[["Top 10 non-official languages primarily spoken at home"]] %>%
    mutate(label = forcats::fct_inorder(label)) %>%
    inline_barchart()
}

header_and_barchart(
  subsection_heading("Top non-official languages spoken at home"),
  top_languages
)
```

:::

```{r section-income-housing}
section_heading("Income and housing")
```

::: {.row .mb-2}

```{r median_income}
median_income_label <- ifelse(length(regions) == 1, "Median household income", "Estimated median household income")

median_income <- data[[median_income_label]] %>%
  pull_and_format_value("dollar")

shiny::column(
  width = 4,
  snapshot_card(median_income_label, median_income)
)
```

```{r lim_at}
lim_at <- data[["Low-income measure after tax (LIM-AT)"]] %>% pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 4,
  snapshot_card("Low income (LIM-AT)", lim_at)
)
```

```{r unaffordable_housing}
unaffordable_housing <- data[["Unaffordable housing"]] %>% pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 4,
  snapshot_card("Unaffordable housing", unaffordable_housing)
)
```

:::

```{r}
suppressed_note(median_income, lim_at, unaffordable_housing)
```

::: {.row}

```{r total-income}
header_and_barchart(
  subsection_heading("Total household income"),
  data[["Total household income ($20,000 buckets)"]] %>%
    mutate(label = forcats::fct_inorder(label)) %>%
    inline_barchart()
)
```

```{r shelter-cost}
shelter_cost <- data[["Average shelter cost"]]

# If they are all NA, then fake as proportion so that no bars are shown
shelter_cost_format <- ifelse(all(is.na(shelter_cost[["value"]])), "proportion", "dollar")

# Remove 'count' field if still there, fix widths
shelter_cost <- shelter_cost %>%
    inline_barchart(shelter_cost_format)

if ("count" %in% names(shelter_cost[["_data"]])) {
  shelter_cost <- shelter_cost %>%
    gt::cols_hide(count) %>%
    gt::cols_width(label ~ 250, value_fmt ~ 
      75, hist ~ 100)
}

header_and_barchart(
  subsection_heading("Average shelter cost"),
  shelter_cost,
  subsection_heading("Household tenure"),
  data[["Tenure"]] %>%
    mutate(label = fct_inorder(label)) %>%
    inline_barchart()
)
```

:::

<div class = "pagebreak"></div>

```{r section-diversity-immigration}
section_heading("Diversity and immigration")
```

::: {.row .mb-2}

```{r visible-minority-summary, eval = TRUE}
visible_minority_summary <- data[["Visible minority population"]] %>%
  filter(label == "Total visible minority population") %>%
  pull_and_format_value(column = "value_proportion")

shiny::column(
  width = 3,
  snapshot_card("Visible minority", visible_minority_summary)
)
```

```{r immigrant-status, eval = TRUE}
immigrant_status_total <- data[["Immigrant status"]] %>%
  filter(label == "Immigrants") %>%
  pull_and_format_value(column = "value_proportion")

immigrant_status_recent <- data[["Immigrant status"]] %>%
  filter(label == "Recent immigrants (2016 to 2021)") %>%
  pull_and_format_value(column = "value_proportion")

shiny::column(
  width = 3,
  snapshot_card("Total immigrants", immigrant_status_total)
)

shiny::column(
  width = 3,
  snapshot_card("Recent immigrants<br>(2016 to 2021)", immigrant_status_recent)
)
```

```{r indigenous-identity}
indigenous_identity <- data[["Indigenous identity"]] %>%
  pull_and_format_value(column = "value_proportion")
shiny::column(
  width = 3,
  snapshot_card(
    "Indigenous identity", indigenous_identity
  )
)
```

:::

```{r}
suppressed_note(visible_minority_summary, immigrant_status_total, immigrant_status_recent, indigenous_identity)
```

::: {.row}

```{r visible-minority-breakdown}
header_and_barchart(
  subsection_heading("Visible minority population"),
  data[["Visible minority population"]] %>%
    filter(label != "Total visible minority population") %>%
    derive_census_vector_order(by_value = TRUE) %>%
    inline_barchart()
)
```

```{r ethnic_or_cultural_origin, eval}
ethnic_or_cultural_origin <- data[["Top 10 ethnic or cultural origins"]]

if (is.null(ethnic_or_cultural_origin)) {
  ethnic_or_cultural_origin <- "No data available on ethnic or cultural origin."
} else {
  ethnic_or_cultural_origin <- data[["Top 10 ethnic or cultural origins"]] %>%
    mutate(label = forcats::fct_inorder(label)) %>%
    inline_barchart()
}

header_and_barchart(
  subsection_heading("Top ethnic or cultural origins"),
  ethnic_or_cultural_origin
)
```

:::

<div class = "pagebreak"></div>

```{r}
section_heading("Definitions")
```

::: {.row}

```{r variable-definitions}
# Split into two columns manually, after "Language spoken most often at home" will make it fit on 1 page

cutoff <- censusaggregatorapp::variable_definitions %>%
  mutate(id = row_number()) %>%
  filter(str_detect(variable_definition, "Language spoken most often at home")) %>%
  pull(id)

definitions_table <- function(data) {
  data %>%
    gt::gt() %>%
    gt::cols_align("left", variable_definition) %>%
    gt::fmt_markdown(columns = variable_definition) %>%
    gt::tab_options(
      column_labels.hidden = TRUE,
      table_body.border.bottom.color = "transparent",
      table_body.border.top.color = "transparent",
      table.font.names = "Lato",
      table.font.size = 13
    )
}

shiny::column(
  width = 6,
  censusaggregatorapp::variable_definitions %>%
    filter(row_number() <= cutoff) %>%
    definitions_table()
)

shiny::column(
  width = 6,
  censusaggregatorapp::variable_definitions %>%
    filter(row_number() > cutoff) %>%
    definitions_table()
)
```

:::
